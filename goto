#!/usr/bin/perl
use strict;
use warnings;
use v5.10;
use MIME::Base64;
use Term::ReadKey;
use Socket;
use Cwd qw(getcwd);
use File::Basename;
use File::Path qw(make_path);
use Getopt::Long;

##############################################################
## goto - 单文件同步终极版 + 支持可选代理（专为 luqiucheng）
## 配置目录：~/Documents/config/goto/goto.ini（iCloud 同步）
##############################################################

my $BASE_DIR = "$ENV{HOME}/Documents/config/goto";
my $INI_FILE = "$BASE_DIR/goto.ini";

unless (-d $BASE_DIR) {
    make_path($BASE_DIR) or die "无法创建目录 $BASE_DIR: $!\n";
    say "创建配置目录：$BASE_DIR";
}

my $config = { global => { user => 'root', port => 22 } };
load_config();

my $mode      = 'ssh';
my $recursive = 0;
my $quiet     = 0;
my $proxy     = 0;        # 新增：是否启用代理
my $proxy_host = '127.0.0.1';
my $proxy_port = 7890;    # 默认 Clash 等代理的 SOCKS5 端口，可自行修改

GetOptions(
    "up"          => sub { $mode = 'up' },
    "down"        => sub { $mode = 'down' },
    "ping"        => sub { $mode = 'ping' },
    "list"        => sub { $mode = 'list' },
    "edit"        => sub { $mode = 'edit' },
    "r|recursive" => \$recursive,
    "q|quiet"     => \$quiet,
    "x|proxy"     => \$proxy,                  # 新增参数：-x 或 --proxy 启用代理
    "h|help"      => sub { print_help(); exit 0 },
) or exit 1;

my $target = shift @ARGV // '';
if (!$target && $mode !~ /^(list|edit)$/) {
    print_help();
}

my $default_user = $config->{global}{user} // 'root';
my $default_port = $config->{global}{port} // 22;

if ($mode eq 'list') { list_hosts(); exit 0; }
if ($mode eq 'edit') { exec($ENV{EDITOR} // 'nano', $INI_FILE); exit 0; }

my ($ip, $port, $user, $pass) = resolve_target($target);

say "→ $user\@$ip:$port (模式: $mode" . ($proxy ? ", 走代理" : "") . ")" unless $quiet;

if    ($mode eq 'ssh')  { ssh_connect($ip, $port, $user, $pass); }
elsif ($mode eq 'ping') { exec("ping", "-c", "4", $ip); }  # ping 不支持代理，保持原样
elsif ($mode eq 'up')   { scp_transfer('up',   $ip, $port, $user, $pass, @ARGV); }
elsif ($mode eq 'down') { scp_transfer('down', $ip, $port, $user, $pass, @ARGV); }
else { die "未知模式: $mode\n"; }

# ==================== 子函数 ====================

sub resolve_target {
    my $input = shift;
    my ($ip, $port, $user, $pass) = ($input, $default_port, $default_user, '');

    if (exists $config->{$input}) {
        my $h = $config->{$input};
        $ip   = $h->{ip}       // $ip;
        $port = $h->{port}     // $port;
        $user = $h->{user}     // $user;
        $pass = $h->{password} ? decode_base64($h->{password}) : '';
        say "使用别名 [$input]" unless $quiet;
    }
    elsif (!is_ip($input)) {
        if (my $packed = gethostbyname($input)) {
            $ip = inet_ntoa($packed);
            say "DNS 解析 $input → $ip" unless $quiet;
        }
    }

    if (!is_ip($ip) && !exists $config->{$input}) {
        add_alias($input);
        return resolve_target($input);
    }
    return ($ip, $port, $user, $pass);
}

sub add_alias {
    my $alias = shift;
    say "添加新别名 [$alias]";
    print "IP: "; chomp(my $ip = <STDIN>);
    die "无效 IP\n" unless is_ip($ip) || gethostbyname($ip);

    print "端口 [$default_port]: "; chomp(my $p = <STDIN>); $p = $default_port if $p eq '';
    print "用户 [$default_user]: "; chomp(my $u = <STDIN>); $u = $default_user if $u eq '';

    print "密码（留空用密钥）: ";
    ReadMode('noecho');
    chomp(my $pass = <STDIN>);
    ReadMode('restore');
    print "\n";

    $config->{$alias} = {
        ip   => $ip,
        port => $p,
        user => $u,
        ($pass ne '' ? (password => encode_base64($pass, '')) : ()),
    };
    save_config();
    say "已保存别名 [$alias]（iCloud 同步后其他机器立即可用）";
}

sub load_config {
    return unless -f $INI_FILE;
    open my $fh, '<', $INI_FILE or die "无法读取 $INI_FILE: $!\n";
    my $section = 'global';
    while (<$fh>) {
        chomp;
        next if /^\s*(#|$)/;
        if (/^\[(.+)\]$/) {
            $section = $1;
            $config->{$section} //= {};
        } elsif (/^\s*(\S+?)\s*=\s*(.*)$/) {
            $config->{$section}{$1} = $2;
        }
    }
    close $fh;
}

sub save_config {
    open my $fh, '>', $INI_FILE or die "无法写入 $INI_FILE: $!\n";
    print $fh "[global]\n";
    print $fh "user=$default_user\n";
    print $fh "port=$default_port\n\n";

    for my $sec (sort grep { $_ ne 'global' } keys %$config) {
        print $fh "[$sec]\n";
        for my $k (qw(ip port user password)) {
            print $fh "$k=$config->{$sec}{$k}\n" if exists $config->{$sec}{$k};
        }
        print $fh "\n";
    }
    close $fh;
    chmod 0600, $INI_FILE;
}

sub ssh_connect {
    my ($ip, $port, $user, $pass) = @_;
    my @cmd = ('ssh', '-o', 'StrictHostKeyChecking=no', '-p', $port, "$user\@$ip");

    if ($proxy) {
        push @cmd, '-o', "ProxyCommand=nc -x $proxy_host:$proxy_port %h %p";
    }

    if ($pass && system("which sshpass >/dev/null 2>&1") == 0) {
        unshift @cmd, 'sshpass', '-p', $pass;
    }

    exec(@cmd);
}

sub scp_transfer {
    my ($dir, $ip, $port, $user, $pass, $p1, $p2) = @_;
    die "需要两个路径参数\n" unless $p1 && $p2;

    my @opts = ('scp', '-P', $port, '-o', 'StrictHostKeyChecking=no');
    push @opts, '-r' if $recursive;

    if ($proxy) {
        push @opts, '-o', "ProxyCommand=nc -x $proxy_host:$proxy_port %h %p";
    }

    my ($src, $dst);
    if ($dir eq 'up') {
        die "本地路径不存在: $p1\n" unless -e $p1;
        $src = $p1;
        $dst = "$user\@$ip:$p2";
    } else {
        $src = "$user\@$ip:$p1";
        $dst = $p2;
        $dst =~ s{^~}{$ENV{HOME}};
        $dst = getcwd() if $dst eq '.' || $dst eq './';
        make_path(dirname($dst));
    }

    if ($pass && `which sshpass 2>/dev/null`) {
        unshift @opts, 'sshpass', '-p', $pass;
    }

    say "执行: @opts $src $dst" unless $quiet;
    system(@opts, $src, $dst) == 0 or exit 1;
}

# 其余函数（list_hosts, is_ip, print_help）保持不变
sub list_hosts {
    say "已保存的别名：";
    for my $name (sort grep { $_ ne 'global' } keys %$config) {
        my $h = $config->{$name};
        printf "  %-12s  %-15s  %-6s  %s\n",
            $name,
            $h->{ip} // '-',
            $h->{port} // '22',
            $h->{user} // '-';
    }
}

sub is_ip {
    my $i = shift;
    return 0 unless $i =~ /^(\d{1,3}\.){3}\d{1,3}$/;
    return eval { inet_aton($i); 1 };
}

sub print_help {
    print <<'EOF';
goto - 单文件同步版 + 支持可选代理

用法：
  goto <别名|IP>                    → 直接 SSH
  goto -x <别名|IP>                 → 通过代理 SSH（SOCKS5 127.0.0.1:7890）
  goto up/down [-x] <别名|IP> <路径1> <路径2> → 上传/下载（-x 表示走代理）
  goto ping <别名|IP>               → Ping（不支持代理）
  goto --list                       → 列出所有别名
  goto --edit                       → 编辑配置（iCloud 同步）

新增参数：
  -x 或 --proxy    → 启用 SOCKS5 代理（nc -x 127.0.0.1:7890）

配置文件：~/Documents/config/goto/goto.ini
EOF
    exit 0;
}